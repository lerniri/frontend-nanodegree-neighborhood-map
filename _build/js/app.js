var MapViewModel=function(){function e(){var e={zoom:14,mapTypeControl:!1,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,rotateControl:!0};c=new google.maps.Map(document.querySelector("#map"),e),f=new google.maps.InfoWindow,g=new google.maps.places.PlacesService(c),d=new google.maps.BicyclingLayer,p=new google.maps.TrafficLayer,y=new google.maps.TransitLayer}function a(){var e={query:u.myNeighborhood()};g.textSearch(e,o)}function o(e,a){if(a===v){var o=e[0],r=o.geometry.location.lat(),t=o.geometry.location.lng(),i=new google.maps.LatLng(r,t);c.setCenter(i),n()}}function n(){var e={location:c.getCenter(),radius:1e3,types:["store"]};g.nearbySearch(e,t)}function r(){var e={location:c.getCenter(),radius:1e3,query:u.keywordSearch()};g.textSearch(e,t)}function t(e,a){if(a===v){u.nearbyPlaces([]),s();var o=function(e,a){if(u.loading(!0),a>=e.length)return void u.loading(!1);var n={placeId:e[a].place_id};g.getDetails(n,function(n,r){r===v?(u.nearbyPlaces.push({name:n.name,icon:n.icon,address:n.formatted_address,phone:n.formatted_phone,types:n.types,rating:n.user_ratings_total,website:n.website,reviews:n.reviews}),m.push(new google.maps.Marker({position:n.geometry.location,name:n.name,placeId:n.place_id})),l(m[a],n),o(e,a+1)):r===google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT&&window.setTimeout(function(){o(e,a)},200)})};o(e,0)}else console.log("failed to load places");console.log()}function l(e,a){e.setMap(c),google.maps.event.addListener(e,"click",function(){f.setContent("<div id='infowindow-div' class='noscroll'><h6>"+a.name+"</h6><span>rating: "+(void 0===a.rating?"-":+a.rating)+"</span></div>"),f.open(c,this),c.panTo(e.position)})}function s(){for(var e=0;e<m.length;e++)m[e].setMap(null);m=[]}var c,g,d,p,y,f,u=this,b="Tyshino",m=[],v=google.maps.places.PlacesServiceStatus.OK;u.myNeighborhood=ko.observable(b),u.nearbyPlaces=ko.observableArray(),u.loading=ko.observable(!1),u.keywordSearch=ko.observable(""),u.bikeLayerEnabled=ko.observable(!1),u.trafficLayerEnabled=ko.observable(!1),u.transitLayerEnabled=ko.observable(!1),u.toggleBikeLayer=function(){u.bikeLayerEnabled(!u.bikeLayerEnabled()),u.manageLayers()},u.toggleTrafficLayer=function(){u.trafficLayerEnabled(!u.trafficLayerEnabled()),u.manageLayers()},u.toggleTransitLayer=function(){u.transitLayerEnabled(!u.transitLayerEnabled()),u.manageLayers()},u.panMapToClickedPlace=function(){for(i=0;i<m.length;i++)m[i].name===this.name&&(c.panTo(m[i].position),new google.maps.event.trigger(m[i],"click"))},u.resetSearchFilter=function(){u.keywordSearch(""),a()},e(),u.computedNeighborhood=ko.computed(function(){""!==u.myNeighborhood()&&a()}),u.computedKeywordSearch=ko.computed(function(){""!==u.keywordSearch()&&r()}),u.manageLayers=function(){d.setMap(u.bikeLayerEnabled()?c:null),y.setMap(u.transitLayerEnabled()?c:null),p.setMap(u.trafficLayerEnabled()?c:null)}};ko.applyBindings(new MapViewModel);