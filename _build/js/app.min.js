var MapViewModel=function(){function e(){var e={zoom:14,mapTypeControl:!1,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,rotateControl:!0};p=new google.maps.Map(document.querySelector("#map"),e),f=new google.maps.InfoWindow,b=new google.maps.places.PlacesService(p),m=new google.maps.BicyclingLayer,u=new google.maps.TrafficLayer,h=new google.maps.TransitLayer,google.maps.event.addDomListener(window,"resize",function(){var e=p.getCenter();google.maps.event.trigger(p,"resize"),p.setCenter(e)})}function a(){var e={query:w.myNeighborhood()};b.textSearch(e,n)}function n(e,a){if(a===I){var n=e[0],t=n.geometry.location.lat(),i=n.geometry.location.lng(),r=new google.maps.LatLng(t,i);p.setCenter(r);var s="AIzaSyCV9N5j38lkbSHp46-pYU5Wh01ijgSwq4w",l="https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference="+n.reference+"sensor=true&key="+s;console.log(l),$.ajax({url:l,dataType:"jsonp",success:function(e){console.log(e)}}),o()}}function o(){var e={location:p.getCenter(),radius:1e3,types:v};b.nearbySearch(e,t)}function t(e,a){if(a===I){w.nearbyPlaces([]),s();var n=function(e,a){if(a>=e.length)return void w.loading(!1);var o={placeId:e[a].place_id};b.getDetails(o,function(o,t){t===I?(w.nearbyPlaces.push({name:o.name,icon:o.icon,address:o.formatted_address,phone:o.formatted_phone_number,types:o.types,rating:o.user_ratings_total,website:o.website,reviews:o.reviews,photos:o.photos}),k.push(new google.maps.Marker({position:o.geometry.location,name:o.name,address:o.formatted_address,phone:o.formatted_phone_number})),r(k[a],o),n(e,a+1)):t===_&&window.setTimeout(function(){n(e,a)},200)})};n(e,0)}else console.log("failed to load places")}function r(e){e.setMap(p),google.maps.event.addListener(e,"click",function(){f.setContent("<div id='infowindow-div' class='noscroll'><h6>"+e.name+"</h6><p>"+e.address+"</p><span>"+e.phone+"</span></div>"),f.open(p,this),p.panTo(e.position)})}function s(){for(var e=0;e<k.length;e++)k[e].setMap(null);k=[]}function l(){var e=$(".addinfo-content");w.instagramEnabled()||w.placeInfoEnabled()||w.newsFeedEnabled()?e.addClass("show-addinfo"):w.instagramEnabled()||w.placeInfoEnabled()||w.newsFeedEnabled()||e.removeClass("show-addinfo")}function d(){m.setMap(w.bikeLayerEnabled()?p:null),h.setMap(w.transitLayerEnabled()?p:null),u.setMap(w.trafficLayerEnabled()?p:null)}function c(){if(w.instagramEnabled()&&!(w.neighborhoodImages().length>0)){var e="36229642.37a7c6f.21f4b44989b94872b6116fe8eeededf8",a=p.getCenter().lat(),n=p.getCenter().lng(),o="https://api.instagram.com/v1/media/search?lat="+a+"&lng="+n+"&access_token="+e;w.addInfoLoading(!0),$.ajax({url:o,dataType:"jsonp",success:function(e){if(200===e.meta.code){for(i=0;i<e.data.length;i++)"image"===e.data[i].type&&w.neighborhoodImages.push({author:e.data[i].user.username,name:e.data[i].location.name,thumb_img:e.data[i].images.thumbnail.url,thumb_img_h:e.data[i].images.thumbnail.height,thumb_img_w:e.data[i].images.thumbnail.width,full_img:e.data[i].images.standard_resolution.url,full_img_h:e.data[i].images.standard_resolution.height,full_img_w:e.data[i].images.standard_resolution.width});w.addInfoLoading(!1)}}})}}function g(){function e(e){return"http://en.wikipedia.org/wiki/"+e}if(w.placeInfoEnabled()&&!(w.placeInfoPages().length>0)){var a=y+"format=json&action=query&list=search&srsearch="+w.myNeighborhood()+"&srlimit=5&callback=?";$.ajax({url:a,dataType:"jsonp",success:function(a){for(var n=0;n<a.query.search.length;n++)w.placeInfoPages.push({title:a.query.search[n].title,link:e(a.query.search[n].title),snippet:a.query.search[n].snippet})},error:function(){}})}}var p,b,f,m,u,h,w=this,y="http://en.wikipedia.org/w/api.php?",v=["bakery","bar","cafe","food","movie_theater","museum","park","night_club","restaurant","shopping_mall","zoo"],E="Tushino",k=[],I=google.maps.places.PlacesServiceStatus.OK,_=google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT;w.myNeighborhood=ko.observable(E),w.nearbyPlaces=ko.observableArray(),w.keywordSearch=ko.observable(""),w.neighborhoodImages=ko.observableArray([]),w.bikeLayerEnabled=ko.observable(!1),w.trafficLayerEnabled=ko.observable(!1),w.transitLayerEnabled=ko.observable(!1),w.instagramEnabled=ko.observable(!1),w.placeInfoEnabled=ko.observable(!1),w.newsFeedEnabled=ko.observable(!1),w.placeInfoPages=ko.observableArray([]),w.showAddInfoWindow=ko.observable(!1),w.loading=ko.observable(!1),w.addInfoLoading=ko.observable(!1),w.toggleBikeLayer=function(){w.bikeLayerEnabled(!w.bikeLayerEnabled()),d()},w.toggleTrafficLayer=function(){w.trafficLayerEnabled(!w.trafficLayerEnabled()),d()},w.toggleTransitLayer=function(){w.transitLayerEnabled(!w.transitLayerEnabled()),d()},w.toggleInstagram=function(){w.instagramEnabled(!w.instagramEnabled()),w.instagramEnabled()&&(w.placeInfoEnabled(!1),w.newsFeedEnabled(!1)),c()},w.toggleWiki=function(){w.placeInfoEnabled(!w.placeInfoEnabled()),w.placeInfoEnabled()&&(w.instagramEnabled(!1),w.newsFeedEnabled(!1)),g()},w.toggleNews=function(){w.newsFeedEnabled(!w.newsFeedEnabled()),w.newsFeedEnabled()&&(w.placeInfoEnabled(!1),w.instagramEnabled(!1)),l(),loadNewsBBC()},w.panMapToClickedPlace=function(){for(i=0;i<k.length;i++)k[i].name===this.name&&(p.panTo(k[i].position),new google.maps.event.trigger(k[i],"click"))},w.resetSearchFilter=function(){w.keywordSearch(""),a()},e(),$(document).click(function(e){$(e.target).closest("div.addinfo-content").length>1&&w.showAddInfoWindow(!1)}),w.computedNeighborhood=ko.computed(function(){""!==w.myNeighborhood()&&(w.placeInfoPages([]),w.neighborhoodImages([]),a())}),w.computedKeywordSearch=ko.computed(function(){}),w.computedShowAddInfo=ko.computed(function(){var e=$(".addinfo-content");w.instagramEnabled()||w.placeInfoEnabled()?(w.showAddInfoWindow(!0),e.addClass("show-addinfo")):w.instagramEnabled()||w.placeInfoEnabled()||(w.showAddInfoWindow(!1),e.removeClass("show-addinfo"))})};ko.applyBindings(new MapViewModel);