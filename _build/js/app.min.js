var MapViewModel=function(){function e(){var e={zoom:14,mapTypeControl:!1,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,rotateControl:!0};b=new google.maps.Map(document.querySelector("#map"),e),m=new google.maps.InfoWindow,f=new google.maps.places.PlacesService(b),u=new google.maps.BicyclingLayer,h=new google.maps.TrafficLayer,w=new google.maps.TransitLayer,google.maps.event.addDomListener(window,"resize",function(){var e=b.getCenter();google.maps.event.trigger(b,"resize"),b.setCenter(e)})}function a(){var e={query:y.myNeighborhood()};f.textSearch(e,n)}function n(e,a){if(a===_){var n=e[0],t=n.geometry.location.lat(),i=n.geometry.location.lng(),r=new google.maps.LatLng(t,i);b.setCenter(r);var s="AIzaSyCV9N5j38lkbSHp46-pYU5Wh01ijgSwq4w",l="https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference="+n.reference+"sensor=true&key="+s;console.log(l),$.ajax({url:l,dataType:"jsonp",success:function(e){console.log(e)}}),o()}}function o(){var e={location:b.getCenter(),radius:1e3,types:E};f.nearbySearch(e,r)}function t(){var e={location:b.getCenter(),radius:1e3,query:y.keywordSearch()};f.textSearch(e,r)}function r(e,a){if(a===_){y.nearbyPlaces([]),l();var n=function(e,a){if(a>=e.length)return void y.loading(!1);var o={placeId:e[a].place_id};f.getDetails(o,function(o,t){t===_?(y.nearbyPlaces.push({name:o.name,icon:o.icon,address:o.formatted_address,phone:o.formatted_phone_number,types:o.types,rating:o.user_ratings_total,website:o.website,reviews:o.reviews,photos:o.photos}),I.push(new google.maps.Marker({position:o.geometry.location,name:o.name,address:o.formatted_address,phone:o.formatted_phone_number})),s(I[a],o),n(e,a+1)):t===L&&window.setTimeout(function(){n(e,a)},200)})};n(e,0)}else console.log("failed to load places")}function s(e){e.setMap(b),google.maps.event.addListener(e,"click",function(){m.setContent("<div id='infowindow-div' class='noscroll'><h6>"+e.name+"</h6><p>"+e.address+"</p><span>"+e.phone+"</span></div>"),m.open(b,this),b.panTo(e.position)})}function l(){for(var e=0;e<I.length;e++)I[e].setMap(null);I=[]}function d(){var e=$(".addinfo-content");y.instagramEnabled()||y.placeInfoEnabled()||y.newsFeedEnabled()?e.addClass("show-addinfo"):y.instagramEnabled()||y.placeInfoEnabled()||y.newsFeedEnabled()||e.removeClass("show-addinfo")}function c(){u.setMap(y.bikeLayerEnabled()?b:null),w.setMap(y.transitLayerEnabled()?b:null),h.setMap(y.trafficLayerEnabled()?b:null)}function g(){if(y.instagramEnabled()&&!(y.neighborhoodImages().length>0)){var e="36229642.37a7c6f.21f4b44989b94872b6116fe8eeededf8",a=b.getCenter().lat(),n=b.getCenter().lng(),o="https://api.instagram.com/v1/media/search?lat="+a+"&lng="+n+"&access_token="+e;y.addInfoLoading(!0),$.ajax({url:o,dataType:"jsonp",success:function(e){if(200===e.meta.code){for(i=0;i<e.data.length;i++)"image"===e.data[i].type&&y.neighborhoodImages.push({author:e.data[i].user.username,name:e.data[i].location.name,thumb_img:e.data[i].images.thumbnail.url,thumb_img_h:e.data[i].images.thumbnail.height,thumb_img_w:e.data[i].images.thumbnail.width,full_img:e.data[i].images.standard_resolution.url,full_img_h:e.data[i].images.standard_resolution.height,full_img_w:e.data[i].images.standard_resolution.width});y.addInfoLoading(!1)}}})}}function p(){function e(e){return"http://en.wikipedia.org/wiki/"+e}if(y.placeInfoEnabled()&&!(y.placeInfoPages().length>0)){var a=v+"format=json&action=query&list=search&srsearch="+y.myNeighborhood()+"&srlimit=5&callback=?";$.ajax({url:a,dataType:"jsonp",success:function(a){for(var n=0;n<a.query.search.length;n++)y.placeInfoPages.push({title:a.query.search[n].title,link:e(a.query.search[n].title),snippet:a.query.search[n].snippet})},error:function(){}})}}var b,f,m,u,h,w,y=this,v="http://en.wikipedia.org/w/api.php?",E=["bakery","bar","cafe","food","movie_theater","museum","park","night_club","restaurant","shopping_mall","zoo"],k="Tushino",I=[],_=google.maps.places.PlacesServiceStatus.OK,L=google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT;y.myNeighborhood=ko.observable(k),y.nearbyPlaces=ko.observableArray(),y.keywordSearch=ko.observable(""),y.neighborhoodImages=ko.observableArray([]),y.bikeLayerEnabled=ko.observable(!1),y.trafficLayerEnabled=ko.observable(!1),y.transitLayerEnabled=ko.observable(!1),y.instagramEnabled=ko.observable(!1),y.placeInfoEnabled=ko.observable(!1),y.newsFeedEnabled=ko.observable(!1),y.placeInfoPages=ko.observableArray([]),y.showAddInfoWindow=ko.observable(!1),y.loading=ko.observable(!1),y.addInfoLoading=ko.observable(!1),y.toggleBikeLayer=function(){y.bikeLayerEnabled(!y.bikeLayerEnabled()),c()},y.toggleTrafficLayer=function(){y.trafficLayerEnabled(!y.trafficLayerEnabled()),c()},y.toggleTransitLayer=function(){y.transitLayerEnabled(!y.transitLayerEnabled()),c()},y.toggleInstagram=function(){y.instagramEnabled(!y.instagramEnabled()),y.instagramEnabled()&&(y.placeInfoEnabled(!1),y.newsFeedEnabled(!1)),g()},y.toggleWiki=function(){y.placeInfoEnabled(!y.placeInfoEnabled()),y.placeInfoEnabled()&&(y.instagramEnabled(!1),y.newsFeedEnabled(!1)),p()},y.toggleNews=function(){y.newsFeedEnabled(!y.newsFeedEnabled()),y.newsFeedEnabled()&&(y.placeInfoEnabled(!1),y.instagramEnabled(!1)),d(),loadNewsBBC()},y.panMapToClickedPlace=function(){for(i=0;i<I.length;i++)I[i].name===this.name&&(b.panTo(I[i].position),new google.maps.event.trigger(I[i],"click"))},y.resetSearchFilter=function(){y.keywordSearch(""),a()},e(),y.computedNeighborhood=ko.computed(function(){""!==y.myNeighborhood()&&(y.placeInfoPages([]),y.neighborhoodImages([]),a())}),y.computedKeywordSearch=ko.computed(function(){""!==y.keywordSearch()&&t()}),y.computedShowAddInfo=ko.computed(function(){var e=$(".addinfo-content");y.instagramEnabled()||y.placeInfoEnabled()?(y.showAddInfoWindow(!0),e.addClass("show-addinfo")):y.instagramEnabled()||y.placeInfoEnabled()||(y.showAddInfoWindow(!1),e.removeClass("show-addinfo"))})};ko.applyBindings(new MapViewModel);