var shouter=new ko.subscribable,AddInfoViewModel=function(){{var e=this,o=$("#wikibtn");$("#flickrbtn")}e.wikiEnabled=ko.observable(!1),e.flickrEnabled=ko.observable(!1),e.addInfoLoading=ko.observable(!1),e.showAddInfoWindow=ko.observable(!1),e.wikiEnabled.subscribe(function(e){shouter.notifySubscribers(e,"wikiEnabled")}),e.flickrEnabled.subscribe(function(e){shouter.notifySubscribers(e,"flickrEnabled")}),e.toggleWiki=function(){e.wikiEnabled(!e.wikiEnabled()),e.wikiEnabled()?(o.addClass("selected"),e.flickrEnabled(!1)):o.removeClass("selected")},e.toggleFlickr=function(){e.flickrEnabled(!e.flickrEnabled()),e.flickrEnabled()&&e.wikiEnabled(!1)},e.showAddInfoWindow=ko.computed(function(){var o=$(".addinfo-content");return e.flickrEnabled()||e.wikiEnabled()?(o.addClass("show-addinfo"),!0):e.flickrEnabled()||e.wikiEnabled()?void 0:(o.removeClass("show-addinfo"),!1)})},WikiViewModel=function(){function e(e){if(n.wikiEnabled()&&!(n.wikiPages().length>0)){var a=i+"format=json&action=query&list=search&srsearch="+e+"&srlimit=5&callback=?",r=setTimeout(function(){n.wikiErrorMsg("Failed to get wikipedia resources")},8e3);$.ajax({url:a,dataType:"jsonp",success:function(e){for(var i=0;i<e.query.search.length;i++)n.wikiPages.push({title:e.query.search[i].title,link:o(e.query.search[i].title),snippet:e.query.search[i].snippet});clearTimeout(r)}})}}function o(e){return a+e}var n=this,i="http://ens.wikipedia.org/w/api.php?",a="http://en.wikipedia.org/wiki/";n.wikiPages=ko.observableArray([]),n.myNeighborhood=ko.observable(""),n.wikiEnabled=ko.observable(!1),n.wikiErrorMsg=ko.observable(""),shouter.subscribe(function(e){n.wikiEnabled(e)},n,"wikiEnabled"),shouter.subscribe(function(e){n.myNeighborhood(e),n.wikiPages([])},n,"neighborhood"),n.wikiEnabledComputed=ko.computed(function(){n.wikiEnabled()&&e(n.myNeighborhood())})},FlickrViewModel=function(){function e(){var e=(Date.now()-2592e3,1),r=1,t=n.neighborhoodLoc().lat(),s=n.neighborhoodLoc().lng(),l=n.myNeighborhood(),c=20,d=i+"?method=flickr.photos.search&api_key="+a+"&lat="+t+"&lng="+s+"&text="+l+"&privacy_filter="+e+"&content_type="+r+"&per_page="+c;$.ajax({url:d,data:"format=json",jsonp:"jsoncallback",dataType:"jsonp",success:function(e){for(var i=0;i<e.photos.photo.length;i++)n.neighborhoodImages.push({title:e.photos.photo[i].title,owner:e.photos.photo[i].owner,pic_thumb:o(e.photos.photo[i],"z"),pic:o(e.photos.photo[i],"b")})},error:function(){}}),console.log(n.neighborhoodImages())}function o(e,o){return"https://farm"+e.farm+".staticflickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_"+o+".jpg"}var n=this,i="https://api.flickr.com/services/rest/",a="ae6f6113a6236df9a8fe6eb32616175d";n.flickrEnabled=ko.observable(!1),n.neighborhoodImages=ko.observableArray([]),n.neighborhoodLoc=ko.observable(),n.myNeighborhood=ko.observable(),shouter.subscribe(function(e){n.flickrEnabled(e)},n,"flickrEnabled"),shouter.subscribe(function(e){n.neighborhoodLoc(e)},n,"neighborhoodLoc"),shouter.subscribe(function(e){n.myNeighborhood(e),n.neighborhoodImages([])},n,"neighborhood"),n.computedLoadInstagram=ko.computed(function(){!n.flickrEnabled()||n.neighborhoodImages().length>0||e()})},MapViewModel=function(){function e(){shouter.notifySubscribers(p.myNeighborhood(),"neighborhood");var e={zoom:14,mapTypeControl:!1,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,rotateControl:!0};d=new google.maps.Map(document.querySelector("#map"),e),h=new google.maps.InfoWindow,b=new google.maps.places.PlacesService(d),f=new google.maps.BicyclingLayer,u=new google.maps.TrafficLayer,g=new google.maps.TransitLayer,google.maps.event.addDomListener(window,"resize",function(){var e=d.getCenter();google.maps.event.trigger(d,"resize"),d.setCenter(e)})}function o(){var e={query:p.myNeighborhood()};b.textSearch(e,n)}function n(e,o){if(o===m){var n=e[0],a=n.geometry.location.lat(),r=n.geometry.location.lng(),t=new google.maps.LatLng(a,r);shouter.notifySubscribers(t,"neighborhoodLoc"),d.setCenter(t),i()}}function i(){var e={location:d.getCenter(),radius:2e3,types:k};b.nearbySearch(e,a)}function a(e,o){if(o===m){p.nearbyPlaces([]),l();var n=function(e,o){if(p.loading(!0),o>=e.length)return void p.loading(!1);var i={placeId:e[o].place_id};b.getDetails(i,function(i,a){a===m?(p.nearbyPlaces.push({name:i.name,icon:i.icon,address:i.formatted_address,phone:i.formatted_phone_number,types:i.types,rating:i.user_ratings_total,website:i.website,reviews:i.reviews,photos:i.photos,showItem:!0}),w.push(new google.maps.Marker({position:i.geometry.location,name:i.name,address:i.formatted_address,phone:i.formatted_phone_number,showMarker:!0})),t(w[o],i),n(e,o+1),p.noPlacesToShow(!1)):a===v&&window.setTimeout(function(){n(e,o)},200)})};n(e,0)}}function r(e,o){w.forEach(function(n){e.name===n.name&&(n.showMarker=o)})}function t(e){e.setMap(d),google.maps.event.addListener(e,"click",function(){h.setContent("<div id='infowindow-div' class='noscroll'><h6>"+e.name+"</h6><p>"+e.address+"</p><span>"+e.phone+"</span></div>"),h.open(d,this),d.panTo(e.position),p.chosenMarker(e)}),google.maps.event.addListener(h,"closeclick",function(){""!==p.chosenMarker()&&null!==p.chosenMarker().getAnimation()&&p.chosenMarker().setAnimation(null),p.chosenMarker("")})}function s(){l();for(var e=0;e<w.length;e++)w[e].showMarker&&w[e].setMap(d)}function l(){for(var e=0;e<w.length;e++)w[e].setMap(null);w=[]}function c(){f.setMap(p.bikeLayerEnabled()?d:null),g.setMap(p.transitLayerEnabled()?d:null),u.setMap(p.trafficLayerEnabled()?d:null)}var d,b,h,f,u,g,p=this,k=["bakery","bar","cafe","food","movie_theater","museum","park","night_club","restaurant","shopping_mall","zoo"],w=[],m=google.maps.places.PlacesServiceStatus.OK,v=google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT;p.myNeighborhood=ko.observable(""),p.neighborhoodLoc=ko.observable(),p.nearbyPlaces=ko.observableArray([]),p.noPlacesToShow=ko.observable(!0),p.keywordSearch=ko.observable(""),p.chosenMarker=ko.observable(""),p.bikeLayerEnabled=ko.observable(!1),p.trafficLayerEnabled=ko.observable(!1),p.transitLayerEnabled=ko.observable(!1),p.showAddInfoWindow=ko.observable(!1),p.loading=ko.observable(!1),p.errorMsg=ko.observable(""),p.myNeighborhood.subscribe(function(e){shouter.notifySubscribers(e,"neighborhood")}),p.toggleBikeLayer=function(){p.bikeLayerEnabled(!p.bikeLayerEnabled()),c()},p.toggleTrafficLayer=function(){p.trafficLayerEnabled(!p.trafficLayerEnabled()),c()},p.toggleTransitLayer=function(){p.transitLayerEnabled(!p.transitLayerEnabled()),c()},p.panMapToClickedPlace=function(){for(var e=0;e<w.length;e++)w[e].name===this.name&&(d.panTo(w[e].position),new google.maps.event.trigger(w[e],"click"))},e(),$(document).click(function(e){$(e.target).closest("div.addinfo-content").length>1&&p.showAddInfoWindow(!1)}),p.computedNeighborhood=ko.computed(function(){""!==p.myNeighborhood()&&o()}),p.markerAnimationIsRunning=ko.computed(function(){return""!==p.chosenMarker()?(w.forEach(function(e){e.setAnimation(null)}),null!==p.chosenMarker().getAnimation()?(p.chosenMarker().setAnimation(null),!1):(p.chosenMarker().setAnimation(google.maps.Animation.BOUNCE),!0)):void 0}),p.filterPlaces=function(){var e=p.keywordSearch().split(" "),o=p.nearbyPlaces();p.nearbyPlaces([]),p.noPlacesToShow(!0),o.forEach(function(o){for(var n=o.name,i=!1,a=0;a<e.length;a++){if(1===e.length&&""===e[a])i=!0;else if(n.toLowerCase().indexOf(e[a].toLowerCase())>=0)i=!0;else for(var t=0;t<o.types.length;t++)if(o.types[t].toLowerCase().indexOf(e[a].toLowerCase())>=0){i=!0;break}p.noPlacesToShow()&&p.noPlacesToShow(i?!1:!0),o.showItem=i,r(o,i),p.nearbyPlaces.push(o)}}),p.nearbyPlaces(o),s(w)}},masterViewModel=function(){this.AddInfoViewModel=new AddInfoViewModel,this.WikiViewModel=new WikiViewModel,this.FlickrViewModel=new FlickrViewModel,this.MapViewModel=new MapViewModel};ko.applyBindings(new masterViewModel);