var shouter=new ko.subscribable,AddInfoViewModel=function(){var e=this;e.placeInfoEnabled=ko.observable(!1),e.instagramEnabled=ko.observable(!1),e.addInfoLoading=ko.observable(!1),e.showAddInfoWindow=ko.observable(!1),e.placeInfoEnabled.subscribe(function(e){shouter.notifySubscribers(e,"placeInfoEnabled")}),e.instagramEnabled.subscribe(function(e){shouter.notifySubscribers(e,"instagramEnabled")}),e.toggleWiki=function(){e.placeInfoEnabled(!e.placeInfoEnabled()),e.placeInfoEnabled()&&e.instagramEnabled(!1)},e.toggleInstagram=function(){e.instagramEnabled(!e.instagramEnabled()),e.instagramEnabled()&&e.placeInfoEnabled(!1)},e.showAddInfoWindow=ko.computed(function(){var o=$(".addinfo-content");return e.instagramEnabled()||e.placeInfoEnabled()?(o.addClass("show-addinfo"),!0):e.instagramEnabled()||e.placeInfoEnabled()?void 0:(o.removeClass("show-addinfo"),!1)})},WikiViewModel=function(){function e(e){if(n.placeInfoEnabled()&&!(n.placeInfoPages().length>0)){var r=a+"format=json&action=query&list=search&srsearch="+e+"&srlimit=5&callback=?";$.ajax({url:r,dataType:"jsonp",success:function(e){for(var a=0;a<e.query.search.length;a++)n.placeInfoPages.push({title:e.query.search[a].title,link:o(e.query.search[a].title),snippet:e.query.search[a].snippet})},error:function(){}})}}function o(e){return r+e}var n=this,a="http://en.wikipedia.org/w/api.php?",r="http://en.wikipedia.org/wiki/";n.placeInfoPages=ko.observableArray([]),n.myNeighborhood=ko.observable(""),n.placeInfoEnabled=ko.observable(!1),shouter.subscribe(function(e){n.placeInfoEnabled(e)},n,"placeInfoEnabled"),shouter.subscribe(function(e){n.myNeighborhood(e),n.placeInfoPages([])},n,"neighborhood"),n.placeInfoEnabledComputed=ko.computed(function(){n.placeInfoEnabled()&&e(n.myNeighborhood())})},FlickrViewModel=function(){function e(){var e=(Date.now()-2592e3,1),t=1,i=n.neighborhoodLoc().lat(),s=n.neighborhoodLoc().lng(),l=n.myNeighborhood(),c=20,d=a+"?method=flickr.photos.search&api_key="+r+"&lat="+i+"&lng="+s+"&text="+l+"&privacy_filter="+e+"&content_type="+t+"&per_page="+c;$.ajax({url:d,data:"format=json",jsonp:"jsoncallback",dataType:"jsonp",success:function(e){for(var a=0;a<e.photos.photo.length;a++)n.neighborhoodImages.push({title:e.photos.photo[a].title,owner:e.photos.photo[a].owner,pic_thumb:o(e.photos.photo[a],"z"),pic:o(e.photos.photo[a],"b")})},error:function(){}}),console.log(n.neighborhoodImages())}function o(e,o){return"https://farm"+e.farm+".staticflickr.com/"+e.server+"/"+e.id+"_"+e.secret+"_"+o+".jpg"}var n=this,a="https://api.flickr.com/services/rest/",r="ae6f6113a6236df9a8fe6eb32616175d";n.instagramEnabled=ko.observable(!1),n.neighborhoodImages=ko.observableArray([]),n.neighborhoodLoc=ko.observable(),n.myNeighborhood=ko.observable(),shouter.subscribe(function(e){n.instagramEnabled(e)},n,"instagramEnabled"),shouter.subscribe(function(e){n.neighborhoodLoc(e)},n,"neighborhoodLoc"),shouter.subscribe(function(e){n.myNeighborhood(e),n.neighborhoodImages([])},n,"neighborhood"),n.computedLoadInstagram=ko.computed(function(){!n.instagramEnabled()||n.neighborhoodImages().length>0||e()})},InstagramViewModel=function(){var e=this;e.instagramEnabled=ko.observable(!1),e.neighborhoodImages=ko.observableArray([]),e.neighborhoodLoc=ko.observable(),shouter.subscribe(function(o){e.instagramEnabled(o)},e,"instagramEnabled"),shouter.subscribe(function(o){e.neighborhoodLoc(o)},e,"neighborhoodLoc")},MapViewModel=function(){function e(){shouter.notifySubscribers(m.myNeighborhood(),"neighborhood");var e={zoom:14,mapTypeControl:!1,scaleControl:!0,streetViewControl:!0,overviewMapControl:!0,rotateControl:!0};b=new google.maps.Map(document.querySelector("#map"),e),g=new google.maps.InfoWindow,h=new google.maps.places.PlacesService(b);{var o={};new google.maps.Geocoder}if(google.loader.ClientLocation){o.lat=google.loader.ClientLocation.latitude,o.lng=google.loader.ClientLocation.longitude;{new google.maps.LatLng(o.lat,o.lng)}}f=new google.maps.BicyclingLayer,u=new google.maps.TrafficLayer,p=new google.maps.TransitLayer,google.maps.event.addDomListener(window,"resize",function(){var e=b.getCenter();google.maps.event.trigger(b,"resize"),b.setCenter(e)})}function o(){var e={query:m.myNeighborhood()};h.textSearch(e,n)}function n(e,o){if(o===v){var n=e[0],r=n.geometry.location.lat(),t=n.geometry.location.lng(),i=new google.maps.LatLng(r,t);shouter.notifySubscribers(i,"neighborhoodLoc"),b.setCenter(i),a()}else console.log("Something is wrong")}function a(){var e={location:b.getCenter(),radius:1e3,types:w};h.nearbySearch(e,r)}function r(e,o){if(o===v){m.nearbyPlaces([]);var n=function(e,o){if(m.loading(!0),o>=e.length)return void m.loading(!1);var a={placeId:e[o].place_id};h.getDetails(a,function(a,r){r===v?(m.nearbyPlaces.push({name:a.name,icon:a.icon,address:a.formatted_address,phone:a.formatted_phone_number,types:a.types,rating:a.user_ratings_total,website:a.website,reviews:a.reviews,photos:a.photos,showItem:!0}),k.push(new google.maps.Marker({position:a.geometry.location,name:a.name,address:a.formatted_address,phone:a.formatted_phone_number,showMarker:!0})),s(k[o],a),n(e,o+1),m.noPlacesToShow(!1)):r===y&&window.setTimeout(function(){n(e,o)},200)})};n(e,0)}else console.log("failed to load places")}function t(e,o){k.forEach(function(n){e.name===n.name&&(n.showMarker=o)})}function s(e){e.setMap(b),google.maps.event.addListener(e,"click",function(){g.setContent("<div id='infowindow-div' class='noscroll'><h6>"+e.name+"</h6><p>"+e.address+"</p><span>"+e.phone+"</span></div>"),g.open(b,this),b.panTo(e.position),m.chosenMarker(e)}),google.maps.event.addListener(g,"closeclick",function(){""!==m.chosenMarker()&&null!==m.chosenMarker().getAnimation()&&m.chosenMarker().setAnimation(null),m.chosenMarker("")})}function l(){c();for(var e=0;e<k.length;e++)k[e].showMarker&&k[e].setMap(b)}function c(){for(var e=0;e<k.length;e++)k[e].setMap(null)}function d(){f.setMap(m.bikeLayerEnabled()?b:null),p.setMap(m.transitLayerEnabled()?b:null),u.setMap(m.trafficLayerEnabled()?b:null)}var b,h,g,f,u,p,m=this,w=["bakery","bar","cafe","food","movie_theater","museum","park","night_club","restaurant","shopping_mall","zoo"],k=[],v=google.maps.places.PlacesServiceStatus.OK,y=google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT;m.myNeighborhood=ko.observable(""),m.neighborhoodLoc=ko.observable(),m.nearbyPlaces=ko.observableArray([]),m.noPlacesToShow=ko.observable(!0),m.keywordSearch=ko.observable(""),m.chosenMarker=ko.observable(""),m.bikeLayerEnabled=ko.observable(!1),m.trafficLayerEnabled=ko.observable(!1),m.transitLayerEnabled=ko.observable(!1),m.showAddInfoWindow=ko.observable(!1),m.loading=ko.observable(!1),m.myNeighborhood.subscribe(function(e){shouter.notifySubscribers(e,"neighborhood")}),m.toggleBikeLayer=function(){m.bikeLayerEnabled(!m.bikeLayerEnabled()),d()},m.toggleTrafficLayer=function(){m.trafficLayerEnabled(!m.trafficLayerEnabled()),d()},m.toggleTransitLayer=function(){m.transitLayerEnabled(!m.transitLayerEnabled()),d()},m.panMapToClickedPlace=function(){for(i=0;i<k.length;i++)k[i].name===this.name&&(b.panTo(k[i].position),new google.maps.event.trigger(k[i],"click"))},m.resetSearchFilter=function(){m.keywordSearch(""),o()},e(),$(document).click(function(e){$(e.target).closest("div.addinfo-content").length>1&&m.showAddInfoWindow(!1)}),m.computedNeighborhood=ko.computed(function(){""!==m.myNeighborhood()&&o()}),m.markerAnimationIsRunning=ko.computed(function(){return""!==m.chosenMarker()?(k.forEach(function(e){e.setAnimation(null)}),null!==m.chosenMarker().getAnimation()?(m.chosenMarker().setAnimation(null),!1):(m.chosenMarker().setAnimation(google.maps.Animation.BOUNCE),!0)):void 0}),m.filterPlaces=function(){var e=m.keywordSearch().split(" "),o=m.nearbyPlaces();m.nearbyPlaces([]),m.noPlacesToShow(!0),o.forEach(function(o){for(var n=o.name,a=!1,r=0;r<e.length;r++){if(1===e.length&&""===e[r])a=!0;else if(n.toLowerCase().indexOf(e[r].toLowerCase())>=0)a=!0;else for(var i=0;i<o.types.length;i++)if(o.types[i].toLowerCase().indexOf(e[r].toLowerCase())>=0){a=!0;break}m.noPlacesToShow()&&m.noPlacesToShow(a?!1:!0),o.showItem=a,t(o,a),m.nearbyPlaces.push(o)}}),m.nearbyPlaces(o),l(k)}},masterViewModel=function(){this.AddInfoViewModel=new AddInfoViewModel,this.WikiViewModel=new WikiViewModel,this.InstagramViewModel=new InstagramViewModel,this.FlickrViewModel=new FlickrViewModel,this.MapViewModel=new MapViewModel};ko.applyBindings(new masterViewModel);